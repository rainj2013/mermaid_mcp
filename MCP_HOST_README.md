# Mermaid MCP Host - æ™ºèƒ½å›¾è¡¨ç”Ÿæˆå™¨

MCP Host æ˜¯ä¸€ä¸ªæ™ºèƒ½åŒ–çš„Mermaidå›¾è¡¨ç”Ÿæˆå·¥å…·ï¼Œå®ƒé›†æˆäº†æœˆä¹‹æš—é¢LLM APIï¼Œèƒ½å¤Ÿç†è§£ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€æè¿°ï¼Œè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„Mermaidå›¾è¡¨ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ§  **æ™ºèƒ½æ„å›¾è¯†åˆ«**ï¼šä½¿ç”¨æœˆä¹‹æš—é¢LLMè‡ªåŠ¨è¯†åˆ«ç”¨æˆ·çš„ç»˜å›¾æ„å›¾
- ğŸ¯ **è‡ªç„¶è¯­è¨€å¤„ç†**ï¼šæ”¯æŒç”¨ä¸­æ–‡æˆ–è‹±æ–‡æè¿°å›¾è¡¨éœ€æ±‚
- ğŸ”— **MCPåè®®é›†æˆ**ï¼šæ— ç¼é›†æˆMCP Serverè¿›è¡Œå›¾è¡¨æ¸²æŸ“
- ğŸ› ï¸ **è‡ªåŠ¨ä¿®å¤**ï¼šLLMè‡ªåŠ¨ä¿®å¤è¯­æ³•é”™è¯¯çš„Mermaidè„šæœ¬
- ğŸ¨ **å¤šå›¾è¡¨ç±»å‹**ï¼šæ”¯æŒæµç¨‹å›¾ã€æ—¶åºå›¾ã€ç±»å›¾ã€çŠ¶æ€å›¾ç­‰å¤šç§ç±»å‹
- ğŸ’¬ **äº¤äº’å¼ä½“éªŒ**ï¼šå‹å¥½çš„å‘½ä»¤è¡Œäº¤äº’ç•Œé¢

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

ä½¿ç”¨ `uv` å®‰è£…é¡¹ç›®ä¾èµ–ï¼š

```bash
# å®‰è£…é¡¹ç›®ä¾èµ–
uv sync
```

### 2. é…ç½®APIå¯†é’¥

1. å¤åˆ¶é…ç½®æ–‡ä»¶æ¨¡æ¿ï¼š
```bash
cp config/config.json.template config/config.json
```

2. ç¼–è¾‘ `config/config.json`ï¼Œå¡«å…¥æ‚¨çš„æœˆä¹‹æš—é¢APIå¯†é’¥ï¼š
```json
{
  "moonshot_api": {
    "api_key": "sk-xxxxxxxxxxxxxxxxxxxx",
    "base_url": "https://api.moonshot.cn/v1",
    "model": "moonshot-v1-8k"
  },
  "mcp_server": {
    "server_url": "http://127.0.0.1:8000/sse"
  }
}
```

### 3. å¯åŠ¨æœåŠ¡

1. **å¯åŠ¨MCP Server**ï¼ˆåœ¨æ–°ç»ˆç«¯ï¼‰ï¼š
```bash
python src/mermaid_mcp_server.py
```

2. **å¯åŠ¨MCP Host**ï¼ˆåœ¨å¦ä¸€ä¸ªç»ˆç«¯ï¼‰ï¼š
```bash
python src/mcp_host.py
```

## ä½¿ç”¨æ–¹æ³•

### äº¤äº’æ¨¡å¼

å¯åŠ¨MCP Hoståï¼Œæ‚¨å¯ä»¥ç›´æ¥ç”¨è‡ªç„¶è¯­è¨€æè¿°å›¾è¡¨éœ€æ±‚ï¼š

```
ğŸ® Mermaid MCP Host - æ™ºèƒ½å›¾è¡¨ç”Ÿæˆå™¨
==================================================
ğŸ’¡ æç¤ºï¼šåªéœ€ç”¨è‡ªç„¶è¯­è¨€æè¿°æ‚¨æƒ³è¦çš„å›¾è¡¨ï¼Œæˆ‘ä¼šè‡ªåŠ¨ç”Ÿæˆ
   ä¾‹å¦‚ï¼š'ç”»ä¸€ä¸ªç”¨æˆ·ç™»å½•çš„æµç¨‹å›¾ï¼ŒåŒ…å«ç”¨æˆ·åå¯†ç éªŒè¯'
==================================================

è¯·è¾“å…¥æ‚¨æƒ³è¦çš„å›¾è¡¨æè¿° (è¾“å…¥ 'quit' é€€å‡º): 
```

### ä½¿ç”¨ç¤ºä¾‹

#### ç¤ºä¾‹1ï¼šæµç¨‹å›¾
```
è¯·è¾“å…¥æ‚¨æƒ³è¦çš„å›¾è¡¨æè¿°: ç”»ä¸€ä¸ªç”¨æˆ·æ³¨å†Œæµç¨‹å›¾ï¼ŒåŒ…æ‹¬é‚®ç®±éªŒè¯ã€å¯†ç è®¾ç½®å’Œä¸ªäººä¿¡æ¯å¡«å†™
```

#### ç¤ºä¾‹2ï¼šæ—¶åºå›¾
```
è¯·è¾“å…¥æ‚¨æƒ³è¦çš„å›¾è¡¨æè¿°: åˆ›å»ºä¸€ä¸ªç”µå•†è®¢å•å¤„ç†çš„æ—¶åºå›¾ï¼ŒåŒ…å«ç”¨æˆ·ã€è®¢å•ç³»ç»Ÿã€æ”¯ä»˜ç½‘å…³å’Œåº“å­˜ç®¡ç†
```

#### ç¤ºä¾‹3ï¼šç±»å›¾
```
è¯·è¾“å…¥æ‚¨æƒ³è¦çš„å›¾è¡¨æè¿°: è®¾è®¡ä¸€ä¸ªå­¦ç”Ÿç®¡ç†ç³»ç»Ÿçš„ç±»å›¾ï¼ŒåŒ…å«å­¦ç”Ÿã€è¯¾ç¨‹ã€æ•™å¸ˆå’Œæˆç»©ç±»
```

#### ç¤ºä¾‹4ï¼šçŠ¶æ€å›¾
```
è¯·è¾“å…¥æ‚¨æƒ³è¦çš„å›¾è¡¨æè¿°: ç»˜åˆ¶è®¢å•çŠ¶æ€çš„çŠ¶æ€å›¾ï¼Œä»å¾…ä»˜æ¬¾åˆ°å·²å‘è´§çš„å„ä¸ªçŠ¶æ€
```

## æ”¯æŒçš„å›¾è¡¨ç±»å‹

MCP Host æ”¯æŒä»¥ä¸‹Mermaidå›¾è¡¨ç±»å‹ï¼š

- **æµç¨‹å›¾ (flowchart)**ï¼šå±•ç¤ºæµç¨‹å’Œå†³ç­–è·¯å¾„
- **æ—¶åºå›¾ (sequence)**ï¼šå±•ç¤ºå¯¹è±¡é—´çš„äº¤äº’åºåˆ—
- **ç±»å›¾ (class)**ï¼šå±•ç¤ºç±»ä¹‹é—´çš„å…³ç³»
- **çŠ¶æ€å›¾ (state)**ï¼šå±•ç¤ºå¯¹è±¡çŠ¶æ€å˜åŒ–
- **å®ä½“å…³ç³»å›¾ (entity)**ï¼šå±•ç¤ºæ•°æ®åº“å®ä½“å…³ç³»
- **ç”˜ç‰¹å›¾ (gantt)**ï¼šå±•ç¤ºé¡¹ç›®æ—¶é—´çº¿
- **ç”¨æˆ·æ—…ç¨‹å›¾ (user-journey)**ï¼šå±•ç¤ºç”¨æˆ·ä½“éªŒæµç¨‹

## é«˜çº§ç”¨æ³•

### ç¼–ç¨‹æ¥å£

æ‚¨å¯ä»¥åœ¨è‡ªå·±çš„ä»£ç ä¸­ä½¿ç”¨MCP Hostï¼š

```python
import asyncio
from src.mcp_host import MCPHost


async def main():
   host = MCPHost("src/config.json")

   # åˆ†æMCP Serverèƒ½åŠ›
   capabilities = await host.analyze_mcp_capabilities()

   # å¤„ç†ç”¨æˆ·è¾“å…¥
   result = await host.process_user_input(
      "åˆ›å»ºä¸€ä¸ªç®€å•çš„ç™»å½•æµç¨‹å›¾ï¼ŒåŒ…å«ç”¨æˆ·åå¯†ç éªŒè¯",
      capabilities
   )

   if result["success"]:
      print(f"å›¾è¡¨å·²ç”Ÿæˆ: {result['image_path']}")
      print(f"Mermaidè„šæœ¬:\n{result['script']}")


if __name__ == "__main__":
   asyncio.run(main())
```

### æ‰¹é‡å¤„ç†

```python
import asyncio
from src.mcp_host import MCPHost


async def batch_process():
   host = MCPHost("src/config.json")
   capabilities = await host.analyze_mcp_capabilities()

   descriptions = [
      "ç”¨æˆ·æ³¨å†Œæµç¨‹å›¾",
      "è®¢å•å¤„ç†æ—¶åºå›¾",
      "æ•°æ®åº“å®ä½“å…³ç³»å›¾"
   ]

   for desc in descriptions:
      result = await host.process_user_input(desc, capabilities)
      if result["success"]:
         print(f"âœ… {desc}: {result['image_path']}")


asyncio.run(batch_process())
```

## é…ç½®è¯´æ˜

### é…ç½®æ–‡ä»¶ç»“æ„

`config.json` æ–‡ä»¶åŒ…å«ä»¥ä¸‹é…ç½®é¡¹ï¼š

```json
{
  "moonshot_api": {
    "api_key": "æ‚¨çš„æœˆä¹‹æš—é¢APIå¯†é’¥",
    "base_url": "https://api.moonshot.cn/v1",
    "model": "moonshot-v1-8k"
  },
  "mcp_server": {
    "server_url": "http://127.0.0.1:8000/sse"
  },
  "host_settings": {
    "log_level": "INFO",
    "max_retries": 3,
    "timeout": 30
  }
}
```

### è·å–æœˆä¹‹æš—é¢APIå¯†é’¥

1. è®¿é—® [æœˆä¹‹æš—é¢å¼€æ”¾å¹³å°](https://platform.moonshot.cn)
2. æ³¨å†Œè´¦å·å¹¶å®Œæˆå®åè®¤è¯
3. åˆ›å»ºAPIå¯†é’¥
4. å°†å¯†é’¥å¡«å…¥ `config.json` çš„ `moonshot_api.api_key` å­—æ®µ

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **APIå¯†é’¥é”™è¯¯**
   ```
   âŒ APIé”™è¯¯ 401: Invalid authentication credentials
   ```
   **è§£å†³ï¼š** æ£€æŸ¥ `config.json` ä¸­çš„APIå¯†é’¥æ˜¯å¦æ­£ç¡®

2. **MCP Serveræœªå¯åŠ¨**
   ```
   âŒ Failed to connect to MCP server
   ```
   **è§£å†³ï¼š** å…ˆå¯åŠ¨MCP Server: `python src/mermaid_mcp_server.py`

3. **ç½‘ç»œè¿æ¥é—®é¢˜**
   ```
   âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥: Cannot connect to host
   ```
   **è§£å†³ï¼š** æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®

4. **å›¾è¡¨ç±»å‹è¯†åˆ«é”™è¯¯**
   ```
   âŒ ç”Ÿæˆçš„å›¾è¡¨ç±»å‹ä¸ç¬¦åˆé¢„æœŸ
   ```
   **è§£å†³ï¼š** åœ¨æè¿°ä¸­æ˜ç¡®æŒ‡å®šå›¾è¡¨ç±»å‹ï¼Œå¦‚"åˆ›å»ºä¸€ä¸ª**æµç¨‹å›¾**"æˆ–"ç»˜åˆ¶**æ—¶åºå›¾**"

### æŸ¥çœ‹æ—¥å¿—

æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ä¿¡æ¯ï¼š
```bash
tail -f mcp_host.log
```

## é¡¹ç›®ç»“æ„

```
mermaid_mcp/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ mcp_host.py          # MCP Hostä¸»ç¨‹åº
â”‚   â”œâ”€â”€ llm_client.py        # æœˆä¹‹æš—é¢LLMå®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ mermaid_mcp_client.py # MCPå®¢æˆ·ç«¯
â”‚   â””â”€â”€ mermaid_mcp_server.py # MCPæœåŠ¡å™¨
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ config.json.template    # é…ç½®æ–‡ä»¶æ¨¡æ¿
â”‚   â”œâ”€â”€ config.json             # ç”¨æˆ·é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ puppeteer-config.json   # macOSæµè§ˆå™¨é…ç½®
â”‚   â””â”€â”€ puppeteer-config-windows.json # Windowsæµè§ˆå™¨é…ç½®
â”œâ”€â”€ logs/
â”œâ”€â”€ output/
â”œâ”€â”€ MCP_HOST_README.md          # æœ¬æ–‡æ¡£
â”œâ”€â”€ MCP_CLIENT_README.md        # å®¢æˆ·ç«¯æ–‡æ¡£
â””â”€â”€ README.md                   # ä¸»é¡¹ç›®æ–‡æ¡£
```
